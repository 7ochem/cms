version: '3.9'
services:
  mysql:
    image: mysql:5.7
    ports:
      - 33069:3306
    environment:
      MYSQL_ROOT_PASSWORD: craft
      MYSQL_DATABASE: craft_test
      MYSQL_USER: craft
      MYSQL_PASSWORD: craft
    healthcheck:
      test: ['CMD', 'mysqladmin', 'ping']
      interval: 10s
      retries: 5
  postgres:
    image: postgres:11-alpine
    ports:
      - 54329:5432
    environment:
      POSTGRES_PASSWORD: craft
      POSTGRES_USER: craft
      POSTGRES_DB: craft_test
    healthcheck:
      test: ['CMD', 'pg_isready', '-U', 'craft', '-d', 'craft_test']
      interval: 5s
      retries: 3
  web:
    build:
      context: ../
      target: craft
      dockerfile: ./tests/Dockerfile
    #    ports:
    #      - 8089:8080
    env_file: .env
    environment:
      CRAFT_APP_ID: CraftCMS
      CRAFT_ENVIRONMENT: dev
      CRAFT_SECURITY_KEY: 1234567890
      CRAFT_DB_DRIVER: mysql
      CRAFT_DB_SERVER: mysql
      CRAFT_DB_PORT: 3306
      CRAFT_DB_DATABASE: craft_test
      CRAFT_DB_USER: craft
      CRAFT_DB_PASSWORD: craft
      CRAFT_DB_SCHEMA:
      CRAFT_DB_TABLE_PREFIX:
      PRIMARY_SITE_URL: http://localhost:8080/
      PW_TEST_DOMAIN: http://localhost:8080/
      PW_AUTHENTICATION_USERNAME: admin
      PW_AUTHENTICATION_PASSWORD: NewPassword
    depends_on:
      postgres:
        condition: service_healthy
      mysql:
        condition: service_healthy
#    healthcheck:
#      test: ["CMD", "nc", "-vz", "-w1", "localhost", "8080"]
#      interval: 3s
#      timeout: 1s
#      retries: 30
#    volumes:
#      - ../.:/repo
#  playwright:
#    build:
#      context: ../
#      target: playwright
#      dockerfile: ./tests/Dockerfile
#    environment:
#      PW_TEST_DOMAIN: http://web:8080/
#      PW_AUTHENTICATION_USERNAME: admin
#      PW_AUTHENTICATION_PASSWORD: NewPassword
#    depends_on:
#      web:
#        condition: service_healthy
#    volumes:
#      - ./playwright/.:/playwright/tests
