"use strict";var SessionStatus,IndexingActions;!function(s){s[s.STOPPED=0]="STOPPED",s[s.RUNNING=1]="RUNNING",s[s.QUEUE=2]="QUEUE"}(SessionStatus||(SessionStatus={})),function(s){s.STOP="asset-indexes/stop-indexing-session"}(IndexingActions||(IndexingActions={}));class AssetIndexer{constructor(s,e){this.indexingSessions={},this.runningSessions={},this.$indexingSessionTable=s,this.indexingSessions={},this.runningSessions={};for(const s of e)this.updateIndexingSessionData(s);e.length>0&&this.$indexingSessionTable.removeClass("hidden")}updateIndexingSessionData(s){const e=this.createSessionFromModel(s);this.indexingSessions[e.getSessionId()]=e,this.renderIndexingSessionRow(e)}renderIndexingSessionRow(s){let e;if(!this.indexingSessions[s.getSessionId()])return void this.$indexingSessionTable.find('tr[data-session-id="'+s.getSessionId()+'"]').remove();e=s.getIndexingSessionRowHtml();const t=this.$indexingSessionTable.find('tr[data-session-id="'+s.getSessionId()+'"]');t.length>0?t.replaceWith(e):this.$indexingSessionTable.find("tbody").append(e)}discardIndexingSession(s){const e=this.indexingSessions[s];delete this.indexingSessions[s],delete this.runningSessions[s],this.renderIndexingSessionRow(e)}processResponse(s,e){if("success"===e&&s.error)alert(s.error);else{if(s.session){const e=this.createSessionFromModel(s.session);this.indexingSessions[e.getSessionId()]=e,this.runningSessions[e.getSessionId()]=!0,this.renderIndexingSessionRow(e)}s.stop&&this.discardIndexingSession(s.stop)}}stopIndexingSession(s){Craft.postActionRequest(IndexingActions.STOP,{sessionId:s},this.processResponse.bind(this))}createSessionFromModel(s){return new AssetIndexingSession(s,this.getSessionStatus(s),this)}getSessionStatus(s){return s.queueId?SessionStatus.QUEUE:this.runningSessions[s.id]?SessionStatus.RUNNING:SessionStatus.STOPPED}}class AssetIndexingSession{constructor(s,e,t){this.indexingSessionData=s,this.status=e,this.indexer=t}getSessionId(){return this.indexingSessionData.id}getIndexingSessionRowHtml(){console.log(this.indexingSessionData);const s=$('<tr class="indexingSession" data-session-id="'+this.getSessionId()+'">');s.data("session-id",this.indexingSessionData.id).data("as-queue",this.indexingSessionData.queueId?this.indexingSessionData.queueId:null),s.append("<td>"+this.indexingSessionData.dateCreated+"</td>"),s.append("<td>"+this.indexingSessionData.dateUpdated+"</td>");const e=$('<td class="progress"></td>').data("total",this.indexingSessionData.totalEntries).data("processed",this.indexingSessionData.processedEntries).css("position","relative"),t=new Craft.ProgressBar(e,!1);t.setItemCount(this.indexingSessionData.totalEntries),t.setProcessedItemCount(this.indexingSessionData.processedEntries),t.updateProgressBar(),t.showProgressBar(),s.append(e.data("progressBar",t)),s.append("<td>"+this.getSessionStatusMessage()+"</td>");const n=this.getActionButtons();return $("<td></td>").append(n).appendTo(s),s}getActionButtons(){if(this.status===SessionStatus.QUEUE)return $();const s=$('<div class="buttons"></div>');let e;switch(this.status){case SessionStatus.RUNNING:e=Craft.t("app","Stop");break;case SessionStatus.STOPPED:e=Craft.t("app","Start");const t=Craft.t("app","Cancel");s.append($("<button />",{type:"button",class:"btn submit",title:t,"aria-label":t}).text(t)).on("click",s=>{const e=$(s.target).parent();e.hasClass("disabled")||(e.addClass("disabled"),this.indexer.stopIndexingSession(this.getSessionId()))})}return s.prepend($("<button />",{type:"button",class:"btn submit",title:e,"aria-label":e}).text(e)),s}getSessionStatusMessage(){switch(this.status){case SessionStatus.STOPPED:return Craft.t("app","Waiting");case SessionStatus.RUNNING:return Craft.t("app","Running");case SessionStatus.QUEUE:return Craft.t("app","Running in background")}}}
//# sourceMappingURL=AssetIndexer.min.js.map
