{"version":3,"file":"webAuthn.js","mappings":"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","sources":["webpack://Craft/webpack/bootstrap","webpack://Craft/webpack/runtime/define property getters","webpack://Craft/webpack/runtime/hasOwnProperty shorthand","webpack://Craft/webpack/runtime/make namespace object","webpack://Craft/./WebAuthnFormHandler.ts","webpack://Craft/./AuthenticationSetupFormHandler.ts","webpack://Craft/../../login/src/LoginForm.ts"],"sourcesContent":["// The require scope\nvar __webpack_require__ = {};\n\n","// define getter functions for harmony exports\n__webpack_require__.d = function(exports, definition) {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = function(obj, prop) { return Object.prototype.hasOwnProperty.call(obj, prop); }","// define __esModule on exports\n__webpack_require__.r = function(exports) {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","import { addContainedJsFilesToPage } from \"../../login/src/LoginForm\";\nimport { AuthenticationSetupFormHandler } from \"./AuthenticationSetupFormHandler\";\nexport class WebAuthnFormHandler extends AuthenticationSetupFormHandler {\n    constructor() {\n        super();\n        this.attachEndpoint = 'authentication/attach-web-authn-credentials';\n        this.disabled = false;\n        this.$container = $('#webauthn-settings');\n        this.attachEvents();\n    }\n    static get $button() {\n        return $('#attach-webauthn');\n    }\n    ;\n    get $status() {\n        return $('#webauthn-status');\n    }\n    /**\n     * @inheritdoc\n     */\n    attachEvents() {\n        WebAuthnFormHandler.$button.on('click', (ev) => {\n            ev.stopImmediatePropagation();\n            if (this.disabled) {\n                return;\n            }\n            this.disable();\n            const afterSessionElevated = () => {\n                this.enable();\n                this.setStatus(Craft.t('app', 'Waiting for a security key'));\n                const $button = $(ev.target);\n                const optionData = $button.data('credential-options');\n                // Sort-of deep copy\n                const keyCredentialOptions = Object.assign(Object.assign({}, optionData), { user: Object.assign({}, optionData.user) });\n                if (optionData.excludeCredentials) {\n                    keyCredentialOptions.excludeCredentials = [...optionData.excludeCredentials];\n                }\n                // proprietary base 64 decode, for some reason\n                keyCredentialOptions.challenge = atob(keyCredentialOptions.challenge.replace(/-/g, '+').replace(/_/g, '/'));\n                keyCredentialOptions.user.id = atob(keyCredentialOptions.user.id.replace(/-/g, '+').replace(/_/g, '/'));\n                // Unpack to binary data\n                keyCredentialOptions.challenge = Uint8Array.from(keyCredentialOptions.challenge, c => c.charCodeAt(0));\n                keyCredentialOptions.user.id = Uint8Array.from(keyCredentialOptions.user.id, c => c.charCodeAt(0));\n                for (const idx in keyCredentialOptions.excludeCredentials) {\n                    let excluded = keyCredentialOptions.excludeCredentials[idx];\n                    keyCredentialOptions.excludeCredentials[idx] = {\n                        id: Uint8Array.from(atob(excluded.id.replace(/-/g, '+').replace(/_/g, '/')), c => c.charCodeAt(0)),\n                        type: excluded.type\n                    };\n                }\n                this.createCredentials(keyCredentialOptions)\n                    .then((credentials) => this.attachWebAuthnCredential(credentials))\n                    .catch((err) => this.setErrorStatus(err));\n            };\n            const failedToElevateSession = () => {\n                this.enable();\n                this.clearStatus();\n            };\n            try {\n                this.setStatus(Craft.t('app', 'Waiting for elevated session'));\n                Craft.elevatedSessionManager.requireElevatedSession(afterSessionElevated, failedToElevateSession);\n            }\n            catch (message) {\n                this.enable();\n                this.setErrorStatus(message);\n            }\n            return false;\n        });\n    }\n    attachWebAuthnCredential(credentials) {\n        if (this.disabled) {\n            return false;\n        }\n        this.disable();\n        const credentialName = prompt(Craft.t('app', 'Please enter a name for the security key'), Craft.t('app', 'Security key'));\n        const requestData = {\n            credentialName: credentialName,\n            credentials: {\n                id: credentials.id,\n                rawId: credentials.id,\n                type: credentials.type,\n                response: {\n                    attestationObject: btoa(String.fromCharCode(...new Uint8Array(credentials.response.attestationObject))),\n                    clientDataJSON: btoa(String.fromCharCode(...new Uint8Array(credentials.response.clientDataJSON))),\n                }\n            }\n        };\n        Craft.postActionRequest(this.attachEndpoint, requestData, (response, textStatus) => {\n            if (response.html) {\n                this.$container.replaceWith(response.html);\n                this.$container = $('#webauthn-settings');\n                this.attachEvents();\n            }\n            if (response.footHtml) {\n                addContainedJsFilesToPage(response.footHtml);\n            }\n            if (response.error) {\n                this.setErrorStatus(response.error);\n            }\n            this.enable();\n        });\n    }\n    /**\n     * Get the WebAuthn server options based on a random string and user info.\n     *\n     * @param randomString\n     * @param userInfo\n     */\n    async createCredentials(keyCredentialOptions) {\n        const credentials = await navigator.credentials.create({\n            publicKey: keyCredentialOptions\n        }).catch((err) => {\n            console.log(err);\n        });\n        if (!credentials) {\n            throw \"Failed to create credentials. Please try again.\";\n        }\n        return credentials;\n    }\n    /**\n     * Disable the setting fields.\n     *\n     * @protected\n     */\n    disable() {\n        this.disabled = true;\n        WebAuthnFormHandler.$button.fadeTo(100, 0.5);\n    }\n    /**\n     * Enable the setting fields.\n     *\n     * @protected\n     */\n    enable() {\n        this.disabled = false;\n        WebAuthnFormHandler.$button.fadeTo(100, 1);\n    }\n    /**\n     * Remove an excluded credential by its id.\n     *\n     * @param credentialId\n     */\n    static removeExcludedCredential(credentialId) {\n        const optionData = WebAuthnFormHandler.$button.data('credential-options');\n        let newExcluded = [];\n        for (const excluded of optionData.excludeCredentials) {\n            // Adjust for the proprietary base64 encode thing.\n            if (excluded.id.replace(/[-_=+\\/]/g, '') !== credentialId.replace(/[-_=+\\/]/g, '')) {\n                // @ts-ignore\n                newExcluded.push(excluded);\n            }\n        }\n        optionData.excludeCredentials = newExcluded;\n        WebAuthnFormHandler.$button.data('credential-options', optionData);\n    }\n}\n","export class AuthenticationSetupFormHandler {\n    constructor() {\n        this.attachEvents();\n    }\n    /**\n     * Clears the status and removes the spinner.\n     *\n     * @protected\n     */\n    clearStatus() {\n        this.setStatus('', false);\n    }\n    /**\n     * Display a status message and an optional spinner.\n     *\n     * @param message\n     * @param showSpinner\n     * @protected\n     */\n    setStatus(message, showSpinner = true, clearAfter = 0) {\n        if (showSpinner) {\n            message = `<div class=\"spinner\"></div><span>${message}</span>`;\n        }\n        this.$status.html(message);\n        if (clearAfter > 0) {\n            setTimeout(() => this.clearStatus(), clearAfter);\n        }\n    }\n    /**\n     * Set an error status for the user to see.\n     *\n     * @param message\n     * @protected\n     */\n    setErrorStatus(message) {\n        this.$status.html(`<div class=\"error\">${message}</div<`);\n    }\n}\n","import { AuthenticationChainHandler } from \"./AuthenticationChainHandler\";\nexport class LoginForm {\n    constructor() {\n        this.disabled = false;\n        Craft.AuthenticationChainHandler = new AuthenticationChainHandler(this, () => ({\n            rememberMe: this.$rememberMe.find('input').prop('checked'),\n        }));\n        if (this.$pendingSpinner.length) {\n            this.$loginForm.trigger('submit');\n        }\n    }\n    get $loginForm() { return $('#login-form'); }\n    get $errors() { return $('#login-errors'); }\n    get $messages() { return $('#login-messages'); }\n    get $spinner() { return $('#spinner'); }\n    get $pendingSpinner() { return $('#spinner-pending'); }\n    get $submit() { return $('#submit'); }\n    get $rememberMe() { return $('#remember-me-container'); }\n    get $username() { return $('#username-field input'); }\n    get $cancelRecover() { return $('#cancel-recover'); }\n    get $recoverAccount() { return $('#recover-account'); }\n    get canRememberUser() { return this.$loginForm.data('can-remember'); }\n    /**\n     * Show an error.\n     *\n     * @param error\n     */\n    showError(error) {\n        this.clearErrors();\n        $('<p style=\"display: none;\">' + error + '</p>')\n            .appendTo(this.$errors)\n            // @ts-ignore\n            .velocity('fadeIn');\n    }\n    /**\n     * Show a message.\n     *\n     * @param message\n     */\n    showMessage(message) {\n        this.clearMessages();\n        $('<p style=\"display: none;\">' + message + '</p>')\n            .appendTo(this.$messages)\n            // @ts-ignore\n            .velocity('fadeIn');\n    }\n    /**\n     * Clear all the errors.\n     *\n     * @protected\n     */\n    clearErrors() {\n        this.$errors.empty();\n    }\n    /**\n     * Clear all the messages.\n     *\n     * @protected\n     */\n    clearMessages() {\n        this.$messages.empty();\n    }\n    enableForm() {\n        this.$submit.addClass('active');\n        this.$spinner.addClass('hidden');\n        this.$loginForm.fadeTo(100, 1);\n        this.disabled = false;\n    }\n    disableForm() {\n        this.$submit.removeClass('active');\n        this.$spinner.removeClass('hidden');\n        this.$loginForm.fadeTo(100, 0.2);\n        this.disabled = true;\n    }\n    isDisabled() {\n        return this.disabled;\n    }\n    showRememberMe() {\n        if (this.canRememberUser) {\n            this.$loginForm.addClass('remember-me');\n            this.$rememberMe.removeClass('hidden');\n        }\n    }\n    hideRememberMe() {\n        this.$loginForm.removeClass('remember-me');\n        this.$rememberMe.addClass('hidden');\n    }\n    showSubmitButton() {\n        this.$submit.removeClass('hidden');\n    }\n    hideSubmitButton() {\n        this.$submit.addClass('hidden');\n    }\n}\nexport function addContainedJsFilesToPage(htmlContent) {\n    const jsFiles = htmlContent.match(/([^\"']+\\.js)/gm);\n    const existingSources = Array.from(document.scripts).map(node => node.getAttribute('src')).filter(val => val && val.length > 0);\n    // For some reason, Chrome will fail to load sourcemap properly when jQuery append is used\n    // So roll our own JS file append-thing.\n    if (jsFiles) {\n        for (const jsFile of jsFiles) {\n            if (!existingSources.includes(jsFile)) {\n                let node = document.createElement('script');\n                node.setAttribute('src', jsFile);\n                document.body.appendChild(node);\n            }\n        }\n        // If that fails, use Craft's thing.\n    }\n    else {\n        Craft.appendFootHtml(htmlContent);\n    }\n}\n"],"names":["__webpack_require__","exports","definition","key","o","Object","defineProperty","enumerable","get","obj","prop","prototype","hasOwnProperty","call","Symbol","toStringTag","value","WebAuthnFormHandler","constructor","this","attachEvents","clearStatus","setStatus","message","showSpinner","clearAfter","$status","html","setTimeout","setErrorStatus","super","attachEndpoint","disabled","$container","$","$button","on","ev","stopImmediatePropagation","disable","afterSessionElevated","enable","Craft","t","optionData","target","data","keyCredentialOptions","assign","user","excludeCredentials","challenge","atob","replace","id","Uint8Array","from","c","charCodeAt","idx","excluded","type","createCredentials","then","credentials","attachWebAuthnCredential","catch","err","failedToElevateSession","elevatedSessionManager","requireElevatedSession","requestData","credentialName","prompt","rawId","response","attestationObject","btoa","String","fromCharCode","clientDataJSON","postActionRequest","textStatus","replaceWith","footHtml","htmlContent","jsFiles","match","existingSources","Array","document","scripts","map","node","getAttribute","filter","val","length","jsFile","includes","createElement","setAttribute","body","appendChild","appendFootHtml","addContainedJsFilesToPage","error","async","navigator","create","publicKey","console","log","fadeTo","static","credentialId","newExcluded","push"],"sourceRoot":""}