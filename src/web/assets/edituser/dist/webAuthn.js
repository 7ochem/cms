!function(){var t={d:function(e,a){for(var r in a)t.o(a,r)&&!t.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:a[r]})},o:function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r:function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};!function(){"use strict";t.r(e),t.d(e,{WebAuthnFormHandler:function(){return a}});class a{constructor(){this.attachEndpoint="authentication/attach-web-authn-credentials",this.disabled=!1,this.$container=$("#webauthn-settings"),this.attachEvents()}static get $button(){return $("#attach-webauthn")}get $status(){return $("#webauthn-status")}attachEvents(){a.$button.on("click",(t=>{if(t.stopImmediatePropagation(),this.disabled)return;this.disable();const e=()=>{this.enable(),this.setStatus(Craft.t("app","Waiting for a security key"));const e=$(t.target).data("credential-options"),a=Object.assign(Object.assign({},e),{user:Object.assign({},e.user)});e.excludeCredentials&&(a.excludeCredentials=[...e.excludeCredentials]),a.challenge=atob(a.challenge.replace(/-/g,"+").replace(/_/g,"/")),a.user.id=atob(a.user.id.replace(/-/g,"+").replace(/_/g,"/")),a.challenge=Uint8Array.from(a.challenge,(t=>t.charCodeAt(0))),a.user.id=Uint8Array.from(a.user.id,(t=>t.charCodeAt(0)));for(const t in a.excludeCredentials){let e=a.excludeCredentials[t];a.excludeCredentials[t]={id:Uint8Array.from(atob(e.id.replace(/-/g,"+").replace(/_/g,"/")),(t=>t.charCodeAt(0))),type:e.type}}this.createCredentials(a).then((t=>this.attachWebAuthnCredential(t))).catch((t=>this.setErrorStatus(t)))},a=()=>{this.enable(),this.clearStatus()};try{this.setStatus(Craft.t("app","Waiting for elevated session")),Craft.elevatedSessionManager.requireElevatedSession(e,a)}catch(t){this.enable(),this.setErrorStatus(t)}return!1}))}attachWebAuthnCredential(t){if(this.disabled)return!1;this.disable();const e={credentialName:prompt(Craft.t("app","Please enter a name for the security key"),Craft.t("app","Security key")),credentials:{id:t.id,rawId:t.id,type:t.type,response:{attestationObject:btoa(String.fromCharCode(...new Uint8Array(t.response.attestationObject))),clientDataJSON:btoa(String.fromCharCode(...new Uint8Array(t.response.clientDataJSON)))}}};Craft.postActionRequest(this.attachEndpoint,e,((t,e)=>{t.html&&(this.$container.replaceWith(t.html),this.$container=$("#webauthn-settings"),this.attachEvents()),t.footHtml&&function(t){const e=t.match(/([^"']+\.js)/gm),a=Array.from(document.scripts).map((t=>t.getAttribute("src"))).filter((t=>t&&t.length>0));if(e){for(const t of e)if(!a.includes(t)){let e=document.createElement("script");e.setAttribute("src",t),document.body.appendChild(e)}}else Craft.appendFootHtml(t)}(t.footHtml),this.enable()}))}async createCredentials(t){const e=await navigator.credentials.create({publicKey:t}).catch((t=>{console.log(t)}));if(!e)throw"Failed to create credentials. Please try again.";return e}disable(){this.disabled=!0,a.$button.fadeTo(100,.5)}enable(){this.disabled=!1,a.$button.fadeTo(100,1)}clearStatus(){this.setStatus("",!1)}setStatus(t,e=!0){e&&(t=`<div class="spinner"></div><span>${t}</span>`),this.$status.html(t)}setErrorStatus(t){this.$status.html(`<div class="error">${t}</div<`)}static removeExcludedCredential(t){const e=a.$button.data("credential-options");let r=[];for(const a of e.excludeCredentials)a.id.replace(/[-_=+\/]/g,"")!==t.replace(/[-_=+\/]/g,"")&&r.push(a);e.excludeCredentials=r,a.$button.data("credential-options",e)}}}();var a=Craft="undefined"==typeof Craft?{}:Craft;for(var r in e)a[r]=e[r];e.__esModule&&Object.defineProperty(a,"__esModule",{value:!0})}();
//# sourceMappingURL=webAuthn.js.map