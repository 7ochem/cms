"use strict";class WebAuthnFormHandler{constructor(){this.attachEndpoint="authentication/attach-web-authn-credentials",this.disabled=!1,this.$button=$("#attach-webauthn"),this.$container=$("#webauthn-settings"),this.attachEvents()}attachEvents(){this.$button.on("click",e=>{e.stopImmediatePropagation();const t=$(e.target).data("credential-options"),a=Object.assign(Object.assign({},t),{user:Object.assign({},t.user)});t.excludeCredentials&&(a.excludeCredentials=[...t.excludeCredentials]),a.challenge=atob(a.challenge.replace(/-/g,"+").replace(/_/g,"/")),a.user.id=atob(a.user.id.replace(/-/g,"+").replace(/_/g,"/")),a.challenge=Uint8Array.from(a.challenge,e=>e.charCodeAt(0)),a.user.id=Uint8Array.from(a.user.id,e=>e.charCodeAt(0));for(const e in a.excludeCredentials){let t=a.excludeCredentials[e];a.excludeCredentials[e]={id:Uint8Array.from(atob(t.id.replace(/-/g,"+").replace(/_/g,"/")),e=>e.charCodeAt(0)),type:t.type}}return this.createCredentials(a).then(e=>{Craft.elevatedSessionManager.requireElevatedSession(()=>this.attachWebAuthnCredential(e))}).catch(e=>{console.log(e)}),!1})}attachWebAuthnCredential(e){if(this.disabled)return!1;this.disable();const t={credentialName:prompt(Craft.t("app","Please enter a name for the credentials"),"Secure credentials"),credentials:{id:e.id,rawId:e.id,type:e.type,response:{attestationObject:btoa(String.fromCharCode(...new Uint8Array(e.response.attestationObject))),clientDataJSON:btoa(String.fromCharCode(...new Uint8Array(e.response.clientDataJSON)))}}};Craft.postActionRequest(this.attachEndpoint,t,(e,t)=>{e.html&&(this.$container.replaceWith(e.html),this.$container=$("#webauthn-settings"),this.attachEvents()),this.enable()})}async createCredentials(e){const t=await navigator.credentials.create({publicKey:e}).catch(e=>{console.log(e)});if(!t)throw"Failed to create credentials";return t}disable(){this.disabled=!0,this.$button.fadeTo(100,.5)}enable(){this.disabled=!1,this.$button.fadeTo(100,1)}}new WebAuthnFormHandler;
//# sourceMappingURL=WebAuthnFormHandler.min.js.map
