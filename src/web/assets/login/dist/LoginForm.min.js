"use strict";class LoginForm{constructor(e){this.switchEndpoint="authentication/switch-authentication-step",this.$loginForm=$("#login-form"),this.$errors=$("#login-errors"),this.$messages=$("#login-messages"),this.$spinner=$("#spinner"),this.$pendingSpinner=$("#spinner-pending"),this.$submit=$("#submit"),this.$rememberMeCheckbox=$("#rememberMe"),this.$cancelRecover=$("#cancel-recover"),this.$recoverAccount=$("#recover-account"),this.$alternatives=$("#alternatives"),this.disabled=!1,this.stepHandlers={},this.endpoints={};for(const t of e)this.endpoints[t.id]=$(t).data("endpoint");this.$loginForm.on("submit",e=>(this.invokeStepHandler(e),!1)),this.$pendingSpinner.length&&this.$loginForm.trigger("submit"),this.$recoverAccount.on("click",this.switchForm.bind(this)),this.$cancelRecover.on("click",this.switchForm.bind(this)),this.$alternatives.on("click","li",e=>{this.switchStep($(e.target).attr("rel"))})}registerStepHandler(e,t){this.stepHandlers[e]=t}performStep(e){this.isDisabled()||(this.disableForm(),this.$rememberMeCheckbox.prop("checked")&&(e.rememberMe=!0),this.clearMessages(),this.clearErrors(),Craft.postActionRequest(this.getActiveContainer().data("endpoint"),e,this.processResponse.bind(this)))}switchStep(e){this.isDisabled()||(this.disableForm(),Craft.postActionRequest(this.getActiveContainer().data("endpoint"),{stepType:e,switch:!0},this.processResponse.bind(this)))}processResponse(e,t){var s;if("success"==t){if(e.success&&(null===(s=e.returnUrl)||void 0===s?void 0:s.length))return void(window.location.href=e.returnUrl);if(e.error&&(this.showError(e.error),Garnish.shake(this.$loginForm)),e.message&&this.showMessage(e.message),e.html&&(this.getActiveContainer().empty(),this.getActiveContainer().html(e.html)),e.alternatives&&Object.keys(e.alternatives).length>0?this.showAlternatives(e.alternatives):this.hideAlternatives(),e.stepType&&this.getActiveContainer().attr("rel",e.stepType),e.footHtml){const t=e.footHtml.match(/([^"']+\.js)/gm),s=Array.from(document.scripts).map(e=>e.getAttribute("src")).filter(e=>e&&e.length>0);if(t){for(const e of t)if(!s.includes(e)){let t=document.createElement("script");t.setAttribute("src",e),document.body.appendChild(t)}}else Craft.appendFootHtml(e.footHtml)}e.stepComplete&&(this.$rememberMeCheckbox.parent().remove(),this.$cancelRecover.remove(),this.$recoverAccount.remove())}this.enableForm()}showError(e){this.clearErrors(),$('<p style="display: none;">'+e+"</p>").appendTo(this.$errors).velocity("fadeIn")}showMessage(e){this.clearMessages(),$('<p style="display: none;">'+e+"</p>").appendTo(this.$messages).velocity("fadeIn")}showAlternatives(e){this.$alternatives.removeClass("hidden");const t=this.$alternatives.find("ul").empty();for(const[s,i]of Object.entries(e))t.append($(`<li rel="${s}">${i}</li>`))}hideAlternatives(){this.$alternatives.addClass("hidden"),this.$alternatives.find("ul").empty()}async invokeStepHandler(e){const t=this.getActiveContainer().attr("rel"),s=this.stepHandlers[t].bind(this);try{this.performStep(await s())}catch(e){this.showError(e)}}clearErrors(){this.$errors.empty()}switchForm(){this.$cancelRecover.toggleClass("hidden"),this.$recoverAccount.toggleClass("hidden");for(const e of Object.keys(this.endpoints))$("#"+e).toggleClass("hidden")}clearMessages(){this.$messages.empty()}enableForm(){this.$submit.addClass("active"),this.$spinner.addClass("hidden"),this.$loginForm.fadeTo(100,1),this.disabled=!1}disableForm(){this.$submit.removeClass("active"),this.$spinner.removeClass("hidden"),this.$loginForm.fadeTo(100,.2),this.disabled=!0}isDisabled(){return this.disabled}getActiveContainer(){return $(".authentication-chain").not(".hidden")}}Craft.LoginForm=new LoginForm($(".authentication-chain"));
//# sourceMappingURL=LoginForm.min.js.map
