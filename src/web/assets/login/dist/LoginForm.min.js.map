{"version":3,"sources":["login/src/LoginForm.js"],"names":["LoginForm","constructor","authenticationEndpoint","this","recoverEndpoint","$","$loginForm","$authContainer","$recoverContainer","$errors","$messages","$spinner","$pendingSpinner","$submit","$rememberMeCheckbox","$cancelRecover","showingRecoverForm","on","invokeStepHandler","bind","length","trigger","switchForm","performStep","request","scenario","handler","endpoint","Craft","cpLoginChain","prop","rememberMe","clearMessages","clearErrors","container","postActionRequest","response","textStatus","_a","success","returnUrl","window","shake","error","showError","message","showMessage","location","html","undefined","jsFiles","footHtml","match","jsFile","node","document","createElement","setAttribute","body","appendChild","stepComplete","parent","remove","$recoverAccount","appendTo","enableForm","velocity","isRecoveryStep","recoveryStepHandler","authenticationStepHandler","ev","registerStepHandler","data","disableForm","toggleClass","empty","addClass","removeClass"],"mappings":"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","file":"LoginForm.min.js","sourcesContent":["\"use strict\";\nclass LoginForm {\n    constructor() {\n        this.authenticationEndpoint = 'authentication/perform-authentication';\n        this.recoverEndpoint = 'authentication/recover-account';\n        this.$loginForm = $('#login-form');\n        this.$authContainer = $('#authentication-container');\n        this.$recoverContainer = $('#recovery-container');\n        this.$errors = $('#login-errors');\n        this.$messages = $('#login-messages');\n        this.$spinner = $('#spinner');\n        this.$pendingSpinner = $('#spinner-pending');\n        this.$submit = $('#submit');\n        this.$rememberMeCheckbox = $('#rememberMe');\n        this.$cancelRecover = $('#cancel-recover');\n        this.$recoverAccount = $('#recover-account');\n        /**\n         * Whether currently the account recovery form is shown.\n         *\n         * @private\n         */\n        this.showingRecoverForm = false;\n        this.$loginForm.on('submit', this.invokeStepHandler.bind(this));\n        if (this.$pendingSpinner.length) {\n            this.$loginForm.trigger('submit');\n        }\n        this.$recoverAccount.on('click', this.switchForm.bind(this));\n        this.$cancelRecover.on('click', this.switchForm.bind(this));\n    }\n    /**\n     * Perform the authentication step against the endpoint.\n     *\n     * @param request\n     * @param cb\n     */\n    performStep(request) {\n        request.scenario = Craft.cpLoginChain;\n        if (this.$rememberMeCheckbox.prop('checked')) {\n            request.rememberMe = true;\n        }\n        this.clearMessages();\n        this.clearErrors();\n        let container;\n        let handler;\n        let endpoint;\n        if (this.showingRecoverForm) {\n            endpoint = this.recoverEndpoint;\n            container = this.$recoverContainer;\n            handler = \"recoveryStepHandler\";\n        }\n        else {\n            endpoint = this.authenticationEndpoint;\n            container = this.$authContainer;\n            handler = \"authenticationStepHandler\";\n        }\n        Craft.postActionRequest(endpoint, request, (response, textStatus) => {\n            var _a;\n            if (textStatus == 'success') {\n                if (response.success && ((_a = response.returnUrl) === null || _a === void 0 ? void 0 : _a.length)) {\n                    window.location.href = response.returnUrl;\n                }\n                else {\n                    if (response.error) {\n                        this.showError(response.error);\n                        Garnish.shake(this.$loginForm);\n                    }\n                    if (response.message) {\n                        this.showMessage(response.message);\n                    }\n                    if (response.html) {\n                        container.html(response.html);\n                        this[handler] = undefined;\n                    }\n                    if (response.footHtml) {\n                        const jsFiles = response.footHtml.match(/([^\"']+\\.js)/gm);\n                        // For some reason, Chrome will fail to load sourcemap properly when jQuery append is used\n                        // So roll our own JS file append-thing.\n                        if (jsFiles) {\n                            for (const jsFile of jsFiles) {\n                                let node = document.createElement('script');\n                                node.setAttribute('src', jsFile);\n                                document.body.appendChild(node);\n                            }\n                            // If that fails, use Craft's thing.\n                        }\n                        else {\n                            Craft.appendFootHtml(response.footHtml);\n                        }\n                    }\n                    // Just in case this was the first step, remove all the misc things.\n                    if (response.stepComplete) {\n                        this.$rememberMeCheckbox.parent().remove();\n                        this.$cancelRecover.remove();\n                        this.$recoverAccount.remove();\n                    }\n                }\n            }\n            this.enableForm();\n        });\n    }\n    /**\n     * Show an error.\n     *\n     * @param error\n     */\n    showError(error) {\n        this.clearErrors();\n        $('<p style=\"display: none;\">' + error + '</p>')\n            .appendTo(this.$errors)\n            // @ts-ignore\n            .velocity('fadeIn');\n    }\n    /**\n     * Show a message.\n     *\n     * @param message\n     */\n    showMessage(message) {\n        this.clearMessages();\n        $('<p style=\"display: none;\">' + message + '</p>')\n            .appendTo(this.$messages)\n            // @ts-ignore\n            .velocity('fadeIn');\n    }\n    /**\n     * Register an authentication step handler function that performs validation and data preparation.\n     * It must return either a hash of data to be submitted for authentication or a string which is then interpreted as an error message.\n     * If an empty string is returned, no action is taken.\n     *\n     * @param handler\n     * @param isRecoveryStep whether this is an account recovery step handler.\n     */\n    registerStepHandler(handler, isRecoveryStep = false) {\n        if (isRecoveryStep) {\n            this.recoveryStepHandler = handler;\n        }\n        else {\n            this.authenticationStepHandler = handler;\n        }\n    }\n    /**\n     * Invoke the current authentication or recovery step handler.\n     * @param ev\n     */\n    invokeStepHandler(ev) {\n        const handler = this.showingRecoverForm ? this.recoveryStepHandler : this.authenticationStepHandler;\n        if (typeof handler == \"function\") {\n            const data = handler(ev);\n            if (typeof data == \"object\") {\n                this.disableForm();\n                this.performStep(data);\n            }\n            else {\n                this.showError(data);\n            }\n        }\n        else {\n            this.performStep({});\n        }\n        return false;\n    }\n    /**\n     * Clear all the errors.\n     *\n     * @protected\n     */\n    clearErrors() {\n        this.$errors.empty();\n    }\n    /**\n     * Switch the displayed form between authentication and recovery.\n     *\n     * @protected\n     */\n    switchForm() {\n        this.$authContainer.toggleClass('hidden');\n        this.$recoverContainer.toggleClass('hidden');\n        this.$cancelRecover.toggleClass('hidden');\n        this.$recoverAccount.toggleClass('hidden');\n        this.showingRecoverForm = !this.showingRecoverForm;\n    }\n    /**\n     * Clear all the messages.\n     *\n     * @protected\n     */\n    clearMessages() {\n        this.$messages.empty();\n    }\n    enableForm() {\n        this.$submit.addClass('active');\n        this.$spinner.addClass('hidden');\n    }\n    disableForm() {\n        this.$submit.removeClass('active');\n        this.$spinner.removeClass('hidden');\n    }\n}\nCraft.LoginForm = new LoginForm();\n"]}