{"version":3,"sources":["login/src/LoginForm.js"],"names":["LoginForm","constructor","$chainContainers","switchEndpoint","this","$","$loginForm","$errors","$messages","$spinner","$pendingSpinner","$submit","$rememberMeCheckbox","$cancelRecover","$recoverAccount","$alternatives","disabled","stepHandlers","endpoints","container","id","data","bind","length","trigger","on","switchForm","ev","switchStep","target","attr","registerStepHandler","stepType","handler","performStep","request","isDisabled","disableForm","prop","rememberMe","clearMessages","clearErrors","Craft","getActiveContainer","processResponse","postActionRequest","switch","response","textStatus","_a","success","returnUrl","href","error","showError","Garnish","shake","message","showMessage","html","empty","alternatives","Object","keys","hideAlternatives","footHtml","jsFiles","match","Array","from","document","scripts","map","node","getAttribute","filter","val","jsFile","existingSources","includes","setAttribute","body","appendChild","appendFootHtml","stepComplete","parent","remove","enableForm","appendTo","velocity","showAlternatives","removeClass","$ul","find","description","entries","append","addClass","invokeStepHandler","console","toggleClass","containerId","fadeTo","not"],"mappings":"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","file":"LoginForm.min.js","sourcesContent":["\"use strict\";\nclass LoginForm {\n    constructor($chainContainers) {\n        this.switchEndpoint = 'authentication/switch-authentication-step';\n        this.$loginForm = $('#login-form');\n        this.$errors = $('#login-errors');\n        this.$messages = $('#login-messages');\n        this.$spinner = $('#spinner');\n        this.$pendingSpinner = $('#spinner-pending');\n        this.$submit = $('#submit');\n        this.$rememberMeCheckbox = $('#rememberMe');\n        this.$cancelRecover = $('#cancel-recover');\n        this.$recoverAccount = $('#recover-account');\n        this.$alternatives = $('#alternatives');\n        this.disabled = false;\n        this.stepHandlers = {};\n        this.endpoints = {};\n        for (const container of $chainContainers) {\n            this.endpoints[container.id] = $(container).data('endpoint');\n        }\n        this.$loginForm.on('submit', this.invokeStepHandler.bind(this));\n        if (this.$pendingSpinner.length) {\n            this.$loginForm.trigger('submit');\n        }\n        this.$recoverAccount.on('click', this.switchForm.bind(this));\n        this.$cancelRecover.on('click', this.switchForm.bind(this));\n        this.$alternatives.on('click', 'li', (ev) => {\n            this.switchStep($(ev.target).attr('rel'));\n        });\n    }\n    /**\n     * Register a step handler for a specific type\n     *\n     * @param stepType\n     * @param handler\n     */\n    registerStepHandler(stepType, handler) {\n        this.stepHandlers[stepType] = handler;\n    }\n    /**\n     * Perform the authentication step against the endpoint.\n     *\n     * @param request\n     * @param cb\n     */\n    performStep(request) {\n        if (this.isDisabled()) {\n            return;\n        }\n        this.disableForm();\n        if (this.$rememberMeCheckbox.prop('checked')) {\n            request.rememberMe = true;\n        }\n        this.clearMessages();\n        this.clearErrors();\n        Craft.postActionRequest(this.getActiveContainer().data('endpoint'), request, this.processResponse.bind(this));\n    }\n    /**\n     * Switch the current authentication step to an alternative.\n     *\n     * @param stepType\n     */\n    switchStep(stepType) {\n        if (this.isDisabled()) {\n            return;\n        }\n        this.disableForm();\n        Craft.postActionRequest(this.getActiveContainer().data('endpoint'), {\n            stepType: stepType,\n            switch: true\n        }, this.processResponse.bind(this));\n    }\n    /**\n     * Process authentication response.\n     * @param response\n     * @param textStatus\n     * @protected\n     */\n    processResponse(response, textStatus) {\n        var _a;\n        if (textStatus == 'success') {\n            if (response.success && ((_a = response.returnUrl) === null || _a === void 0 ? void 0 : _a.length)) {\n                window.location.href = response.returnUrl;\n                // Keep the form disabled\n                return;\n            }\n            else {\n                if (response.error) {\n                    this.showError(response.error);\n                    Garnish.shake(this.$loginForm);\n                }\n                if (response.message) {\n                    this.showMessage(response.message);\n                }\n                if (response.html) {\n                    this.getActiveContainer().empty();\n                    this.getActiveContainer().html(response.html);\n                }\n                if (response.alternatives && Object.keys(response.alternatives).length > 0) {\n                    this.showAlternatives(response.alternatives);\n                }\n                else {\n                    this.hideAlternatives();\n                }\n                if (response.stepType) {\n                    this.getActiveContainer().attr('rel', response.stepType);\n                }\n                if (response.footHtml) {\n                    const jsFiles = response.footHtml.match(/([^\"']+\\.js)/gm);\n                    const existingSources = Array.from(document.scripts).map(node => node.getAttribute('src')).filter(val => val && val.length > 0);\n                    // For some reason, Chrome will fail to load sourcemap properly when jQuery append is used\n                    // So roll our own JS file append-thing.\n                    if (jsFiles) {\n                        for (const jsFile of jsFiles) {\n                            if (!existingSources.includes(jsFile)) {\n                                let node = document.createElement('script');\n                                node.setAttribute('src', jsFile);\n                                document.body.appendChild(node);\n                            }\n                        }\n                        // If that fails, use Craft's thing.\n                    }\n                    else {\n                        Craft.appendFootHtml(response.footHtml);\n                    }\n                }\n                // Just in case this was the first step, remove all the misc things.\n                if (response.stepComplete) {\n                    this.$rememberMeCheckbox.parent().remove();\n                    this.$cancelRecover.remove();\n                    this.$recoverAccount.remove();\n                }\n            }\n        }\n        this.enableForm();\n    }\n    /**\n     * Show an error.\n     *\n     * @param error\n     */\n    showError(error) {\n        this.clearErrors();\n        $('<p style=\"display: none;\">' + error + '</p>')\n            .appendTo(this.$errors)\n            // @ts-ignore\n            .velocity('fadeIn');\n    }\n    /**\n     * Show a message.\n     *\n     * @param message\n     */\n    showMessage(message) {\n        this.clearMessages();\n        $('<p style=\"display: none;\">' + message + '</p>')\n            .appendTo(this.$messages)\n            // @ts-ignore\n            .velocity('fadeIn');\n    }\n    showAlternatives(alternatives) {\n        this.$alternatives.removeClass('hidden');\n        const $ul = this.$alternatives.find('ul').empty();\n        for (const [stepType, description] of Object.entries(alternatives)) {\n            $ul.append($(`<li rel=\"${stepType}\">${description}</li>`));\n        }\n    }\n    hideAlternatives() {\n        this.$alternatives.addClass('hidden');\n        this.$alternatives.find('ul').empty();\n    }\n    /**\n     * Invoke the current step handler bound to the authentication container\n     * @param ev\n     */\n    invokeStepHandler(ev) {\n        const stepType = this.getActiveContainer().attr('rel');\n        const handler = this.stepHandlers[stepType];\n        console.log(stepType);\n        if (typeof handler == \"function\") {\n            const data = handler(ev);\n            if (typeof data == \"object\") {\n                this.performStep(data);\n            }\n            else {\n                this.showError(data);\n            }\n        }\n        else {\n            this.performStep({});\n        }\n        return false;\n    }\n    /**\n     * Clear all the errors.\n     *\n     * @protected\n     */\n    clearErrors() {\n        this.$errors.empty();\n    }\n    /**\n     * Switch the displayed form between authentication and recovery.\n     *\n     * @protected\n     */\n    switchForm() {\n        this.$cancelRecover.toggleClass('hidden');\n        this.$recoverAccount.toggleClass('hidden');\n        for (const containerId of Object.keys(this.endpoints)) {\n            $('#' + containerId).toggleClass('hidden');\n        }\n    }\n    /**\n     * Clear all the messages.\n     *\n     * @protected\n     */\n    clearMessages() {\n        this.$messages.empty();\n    }\n    enableForm() {\n        this.$submit.addClass('active');\n        this.$spinner.addClass('hidden');\n        this.$loginForm.fadeTo(100, 1);\n        this.disabled = false;\n    }\n    disableForm() {\n        this.$submit.removeClass('active');\n        this.$spinner.removeClass('hidden');\n        this.$loginForm.fadeTo(100, 0.2);\n        this.disabled = true;\n    }\n    isDisabled() {\n        return this.disabled;\n    }\n    getActiveContainer() {\n        return $('.authentication-chain').not('.hidden');\n    }\n}\nCraft.LoginForm = new LoginForm($('.authentication-chain'));\n"]}