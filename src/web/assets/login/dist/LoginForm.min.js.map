{"version":3,"sources":["login/src/LoginForm.js"],"names":["LoginForm","constructor","authenticationTarget","this","recoverTarget","$","$loginForm","$authContainer","$recoverContainer","$errors","$messages","$spinner","$pendingSpinner","$submit","$rememberMeCheckbox","$cancelRecover","showingRecoverForm","on","invokeStepHandler","bind","length","trigger","switchForm","performStep","request","scenario","container","handler","Craft","cpLoginChain","prop","rememberMe","clearMessages","clearErrors","target","postActionRequest","response","textStatus","_a","success","returnUrl","error","showError","message","showMessage","location","html","undefined","shake","appendFootHtml","footHtml","parent","remove","$recoverAccount","enableForm","appendTo","velocity","registerStepHandler","isRecoveryStep","authenticationStepHandler","ev","recoveryStepHandler","data","empty","toggleClass","addClass","disableForm","removeClass"],"mappings":"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","file":"LoginForm.min.js","sourcesContent":["\"use strict\";\nclass LoginForm {\n    constructor() {\n        this.authenticationTarget = 'authentication/perform-authentication';\n        this.recoverTarget = 'authentication/recover-account';\n        this.$loginForm = $('#login-form');\n        this.$authContainer = $('#authentication-container');\n        this.$recoverContainer = $('#recovery-container');\n        this.$errors = $('#login-errors');\n        this.$messages = $('#login-messages');\n        this.$spinner = $('#spinner');\n        this.$pendingSpinner = $('#spinner-pending');\n        this.$submit = $('#submit');\n        this.$rememberMeCheckbox = $('#rememberMe');\n        this.$cancelRecover = $('#cancel-recover');\n        this.$recoverAccount = $('#recover-account');\n        /**\n         * Whether currently the account recovery form is shown.\n         *\n         * @private\n         */\n        this.showingRecoverForm = false;\n        this.$loginForm.on('submit', this.invokeStepHandler.bind(this));\n        if (this.$pendingSpinner.length) {\n            this.$loginForm.trigger('submit');\n        }\n        this.$recoverAccount.on('click', this.switchForm.bind(this));\n        this.$cancelRecover.on('click', this.switchForm.bind(this));\n    }\n    /**\n     * Perform the authentication step against the endpoint.\n     *\n     * @param request\n     * @param cb\n     */\n    performStep(request) {\n        request.scenario = Craft.cpLoginChain;\n        if (this.$rememberMeCheckbox.prop('checked')) {\n            request.rememberMe = true;\n        }\n        this.clearMessages();\n        this.clearErrors();\n        let target;\n        let container;\n        let handler;\n        if (this.showingRecoverForm) {\n            target = this.recoverTarget;\n            container = this.$recoverContainer;\n            handler = \"recoveryStepHandler\";\n        }\n        else {\n            target = this.authenticationTarget;\n            container = this.$authContainer;\n            handler = \"authenticationStepHandler\";\n        }\n        Craft.postActionRequest(target, request, (response, textStatus) => {\n            var _a;\n            if (textStatus == 'success') {\n                if (response.success && ((_a = response.returnUrl) === null || _a === void 0 ? void 0 : _a.length)) {\n                    window.location.href = response.returnUrl;\n                }\n                else {\n                    if (response.error) {\n                        this.showError(response.error);\n                        Garnish.shake(this.$loginForm);\n                    }\n                    if (response.message) {\n                        this.showMessage(response.message);\n                    }\n                    if (response.html) {\n                        container.html(response.html);\n                        this[handler] = undefined;\n                    }\n                    if (response.footHtml) {\n                        Craft.appendFootHtml(response.footHtml);\n                    }\n                    // Just in case this was the first step, remove all the misc things.\n                    if (response.stepComplete) {\n                        this.$rememberMeCheckbox.parent().remove();\n                        this.$cancelRecover.remove();\n                        this.$recoverAccount.remove();\n                    }\n                }\n            }\n            this.enableForm();\n        });\n    }\n    /**\n     * Show an error.\n     *\n     * @param error\n     */\n    showError(error) {\n        this.clearErrors();\n        $('<p style=\"display: none;\">' + error + '</p>')\n            .appendTo(this.$errors)\n            // @ts-ignore\n            .velocity('fadeIn');\n    }\n    /**\n     * Show a message.\n     *\n     * @param message\n     */\n    showMessage(message) {\n        this.clearMessages();\n        $('<p style=\"display: none;\">' + message + '</p>')\n            .appendTo(this.$messages)\n            // @ts-ignore\n            .velocity('fadeIn');\n    }\n    /**\n     * Register an authentication step handler function that performs validation and data preparation.\n     * It must return either a hash of data to be submitted for authentication or a string which is then interpreted as an error message.\n     * If an empty string is returned, no action is taken.\n     *\n     * @param handler\n     * @param isRecoveryStep whether this is an account recovery step handler.\n     */\n    registerStepHandler(handler, isRecoveryStep = false) {\n        if (isRecoveryStep) {\n            this.recoveryStepHandler = handler;\n        }\n        else {\n            this.authenticationStepHandler = handler;\n        }\n    }\n    /**\n     * Invoke the current authentication or recovery step handler.\n     * @param ev\n     */\n    invokeStepHandler(ev) {\n        const handler = this.showingRecoverForm ? this.recoveryStepHandler : this.authenticationStepHandler;\n        if (typeof handler == \"function\") {\n            const data = handler(ev);\n            if (typeof data == \"object\") {\n                this.disableForm();\n                this.performStep(data);\n            }\n            else {\n                this.showError(data);\n            }\n        }\n        else {\n            this.performStep({});\n        }\n        return false;\n    }\n    /**\n     * Clear all the errors.\n     *\n     * @protected\n     */\n    clearErrors() {\n        this.$errors.empty();\n    }\n    /**\n     * Switch the displayed form between authentication and recovery.\n     *\n     * @protected\n     */\n    switchForm() {\n        this.$authContainer.toggleClass('hidden');\n        this.$recoverContainer.toggleClass('hidden');\n        this.$cancelRecover.toggleClass('hidden');\n        this.$recoverAccount.toggleClass('hidden');\n        this.showingRecoverForm = !this.showingRecoverForm;\n    }\n    /**\n     * Clear all the messages.\n     *\n     * @protected\n     */\n    clearMessages() {\n        this.$messages.empty();\n    }\n    enableForm() {\n        this.$submit.addClass('active');\n        this.$spinner.addClass('hidden');\n    }\n    disableForm() {\n        this.$submit.removeClass('active');\n        this.$spinner.removeClass('hidden');\n    }\n}\nCraft.LoginForm = new LoginForm();\n"]}