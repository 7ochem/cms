"use strict";class AuthenticationChainHandler{constructor(t){this.performAuthenticationEndpoint="authentication/perform-authentication",this.startAuthenticationEndpoint="authentication/start-authentication",this.recoverAccountEndpoint="users/send-password-reset-email",this.recoverAccount=!1,this.authenticationSteps={},this.loginForm=t,this.attachListeners()}get $alternatives(){return $("#alternative-types")}get $authenticationStep(){return $("#authentication-step")}get $restartAuthentication(){return $("#restart-authentication")}get $usernameField(){return $("#username-field")}get $recoveryButtons(){return $("#recover-account, #cancel-recover")}get $authenticationGreeting(){return $("#authentication-greeting")}get $recoveryMessage(){return $("#recovery-message")}attachListeners(){this.$alternatives.on("click","li",t=>{this.switchStep($(t.target).attr("rel"))}),this.$restartAuthentication.on("click",this.restartAuthentication.bind(this)),this.$recoveryButtons.on("click",this.toggleRecoverAccountForm.bind(this)),this.loginForm.canRememberUser&&(this.isExistingChain()?this.loginForm.hideRememberMe():this.loginForm.showRememberMe())}resetAuthenticationControls(){this.$authenticationStep.empty().attr("rel",""),this.$authenticationGreeting.remove(),this.$usernameField.removeClass("hidden"),this.$recoveryMessage.addClass("hidden"),this.loginForm.showSubmitButton(),this.loginForm.showRememberMe(),this.hideAlternatives(),this.clearErrors(),this.recoverAccount&&(this.$recoveryButtons.toggleClass("hidden"),this.recoverAccount=!1)}registerAuthenticationStep(t,e){this.authenticationSteps[t]=e}restartAuthentication(t){this.resetAuthenticationControls(),t&&t.preventDefault()}toggleRecoverAccountForm(){if(this.recoverAccount=!this.recoverAccount,this.$recoveryButtons.toggleClass("hidden"),this.recoverAccount?this.$recoveryMessage.removeClass("hidden"):this.$recoveryMessage.addClass("hidden"),!this.isExistingChain())return;let t=null;this.$authenticationStep.attr("rel").length>0&&(t=this.authenticationSteps[this.$authenticationStep.attr("rel")]),this.recoverAccount?(this.$usernameField.removeClass("hidden"),this.$authenticationStep.addClass("hidden"),this.$alternatives.addClass("hidden"),null==t||t.cleanup()):(this.$usernameField.addClass("hidden"),this.$authenticationStep.removeClass("hidden"),this.$authenticationStep.attr("rel"),this.$alternatives.removeClass("hidden"),null==t||t.init())}performStep(t,e){Craft.postActionRequest(t,e,this.processResponse.bind(this))}switchStep(t){this.loginForm.isDisabled()||(this.loginForm.disableForm(),Craft.postActionRequest(this.performAuthenticationEndpoint,{stepType:t,switch:!0},this.processResponse.bind(this)))}processResponse(t,e){var i,s,n;if("success"==e){if(t.success&&(null===(i=t.returnUrl)||void 0===i?void 0:i.length))return void(window.location.href=t.returnUrl);{if(t.error&&(this.loginForm.showError(t.error),Garnish.shake(this.loginForm.$loginForm)),t.message&&this.loginForm.showMessage(t.message),t.passwordReset&&(t.error||(this.toggleRecoverAccountForm(),this.restartAuthentication())),t.alternatives&&Object.keys(t.alternatives).length>0?this.showAlternatives(t.alternatives):this.hideAlternatives(),t.stepType&&this.$authenticationStep.attr("rel",t.stepType),t.footHtml){const e=t.footHtml.match(/([^"']+\.js)/gm),i=Array.from(document.scripts).map(t=>t.getAttribute("src")).filter(t=>t&&t.length>0);if(e){for(const t of e)if(!i.includes(t)){let e=document.createElement("script");e.setAttribute("src",t),document.body.appendChild(e)}}else Craft.appendFootHtml(t.footHtml)}const e=t=>{this.authenticationSteps[t]&&this.authenticationSteps[t].init()};t.html&&(null===(s=this.currentStep)||void 0===s||s.cleanup(),this.$authenticationStep.html(t.html),e(t.stepType)),t.loginFormHtml&&(null===(n=this.currentStep)||void 0===n||n.cleanup(),this.loginForm.$loginForm.html(t.loginFormHtml),this.attachListeners(),e(t.stepType)),t.stepComplete&&this.loginForm.hideRememberMe()}}this.loginForm.enableForm()}showAlternatives(t){this.$alternatives.removeClass("hidden");const e=this.$alternatives.find("ul").empty();for(const[i,s]of Object.entries(t))e.append($(`<li rel="${i}">${s}</li>`))}hideAlternatives(){this.$alternatives.addClass("hidden"),this.$alternatives.find("ul").empty()}handleFormSubmit(t,e){this.invokeStepHandler(t,e)}async invokeStepHandler(t,e){try{let t;if(this.isExistingChain()){const i=this.$authenticationStep.attr("rel"),s=this.authenticationSteps[i];t=Object.assign(Object.assign({},await s.prepareData()),e),this.currentStep=s}else t=e;if(this.loginForm.isDisabled())return;this.loginForm.disableForm();const i=this.recoverAccount?this.recoverAccountEndpoint:this.isExistingChain()?this.performAuthenticationEndpoint:this.startAuthenticationEndpoint;this.performStep(i,t)}catch(t){this.loginForm.showError(t),this.loginForm.enableForm()}}isExistingChain(){return this.$authenticationStep.attr("rel").length>0}clearErrors(){this.loginForm.clearErrors()}}
//# sourceMappingURL=AuthenticationChainHandler.min.js.map
