"use strict";class AuthenticationChainHandler{constructor(t){this.performAuthenticationEndpoint="authentication/perform-authentication",this.startAuthenticationEndpoint="authentication/start-authentication",this.stepHandlers={},this.loginHandler=t,this.attachListeners()}get $alternatives(){return $("#alternative-types")}get $authenticationStep(){return $("#authentication-step")}get $restartAuthentication(){return $("#restart-authentication")}get $startAuthentication(){return $("#start-authentication")}get $authenticationGreeting(){return $("#authentication-greeting")}attachListeners(){this.$alternatives.on("click","li",t=>{this.switchStep($(t.target).attr("rel"))}),this.$restartAuthentication.on("click",t=>{this.$authenticationStep.empty().attr("rel",""),this.$authenticationGreeting.remove(),this.$startAuthentication.removeClass("hidden"),t.preventDefault()})}registerStepHandler(t,e){this.stepHandlers[t]=e}performStep(t,e){Craft.postActionRequest(t,e,this.processResponse.bind(this))}switchStep(t){this.loginHandler.isDisabled()||(this.loginHandler.disableForm(),Craft.postActionRequest(this.performAuthenticationEndpoint,{stepType:t,switch:!0},this.processResponse.bind(this)))}processResponse(t,e){var i;if("success"==e){if(t.success&&(null===(i=t.returnUrl)||void 0===i?void 0:i.length))return void(window.location.href=t.returnUrl);if(t.error&&(this.loginHandler.showError(t.error),Garnish.shake(this.loginHandler.$loginForm)),t.message&&this.loginHandler.showMessage(t.message),t.html&&this.$authenticationStep.html(t.html),t.loginFormHtml&&(this.loginHandler.$loginForm.html(t.loginFormHtml),this.attachListeners()),t.alternatives&&Object.keys(t.alternatives).length>0?this.showAlternatives(t.alternatives):this.hideAlternatives(),t.stepType&&this.$authenticationStep.attr("rel",t.stepType),t.footHtml){const e=t.footHtml.match(/([^"']+\.js)/gm),i=Array.from(document.scripts).map(t=>t.getAttribute("src")).filter(t=>t&&t.length>0);if(e){for(const t of e)if(!i.includes(t)){let e=document.createElement("script");e.setAttribute("src",t),document.body.appendChild(e)}}else Craft.appendFootHtml(t.footHtml)}t.stepComplete&&(this.loginHandler.$rememberMeCheckbox.parent().remove(),this.loginHandler.$cancelRecover.remove(),this.loginHandler.$recoverAccount.remove())}this.loginHandler.enableForm()}showAlternatives(t){this.$alternatives.removeClass("hidden");const e=this.$alternatives.find("ul").empty();for(const[i,n]of Object.entries(t))e.append($(`<li rel="${i}">${n}</li>`))}hideAlternatives(){this.$alternatives.addClass("hidden"),this.$alternatives.find("ul").empty()}handleFormSubmit(t,e){this.invokeStepHandler(t,e)}async invokeStepHandler(t,e){try{let t;if(this.isExistingChain()){const i=this.$authenticationStep.attr("rel"),n=this.stepHandlers[i];t=Object.assign(Object.assign({},await n()),e)}else t=e;if(this.loginHandler.isDisabled())return;this.loginHandler.disableForm(),this.performStep(this.isExistingChain()?this.performAuthenticationEndpoint:this.startAuthenticationEndpoint,t)}catch(t){this.loginHandler.showError(t),this.loginHandler.enableForm()}}isExistingChain(){return this.$authenticationStep.attr("rel").length>0}clearErrors(){this.loginHandler.clearErrors()}}
//# sourceMappingURL=AuthenticationChainHandler.min.js.map
