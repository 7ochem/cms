{% import "_includes/forms" as forms %}

{% do view.registerAssetBundle('craft\\web\\assets\\admintable\\AdminTableAsset') -%}

<div id="webauthn-settings">
    <h2>{{ 'Manage security keys'|t('app') }}</h2>
    <div id="credentials-vue-admin-table" style="margin-top: 15px;"></div>

    {% if isSecureConnection %}
        <button type="button" id="attach-webauthn" class="btn submit formsubmit" data-credential-options="{{ credentialOptions|e('html_attr') }}">{{ 'Add a security key'|t('app') }}</button>
        <div id="webauthn-status">

        </div>
    {% else %}
        <p>{{ 'A secure connection is required to add a new key'|t('app') }}
    {% endif %}
</div>


{% set tableData = [] %}
{% for credential in existingCredentials %}
    {% set tableData = tableData|merge([{
        id: credential.credentialId,
        title: credential.name,
        name: credential.name,
        lastUsed: credential.lastUsed|length ? credential.lastUsed|date('Y-m-d H:i') : '',
    }]) %}
{% endfor %}

{% js %}
    var columns = [
        { name: 'title', title: Craft.t('app', 'Name') },
        { name: 'lastUsed', title: Craft.t('app', 'Last used') }
    ];

    new Craft.VueAdminTable({
        columns: columns,
        container: '#credentials-vue-admin-table',
        deleteAction: 'authentication/detach-web-authn-credentials',
        emptyMessage: Craft.t('app', 'No security keys exist yet'),
        tableData: {{ tableData|json_encode|raw }},
        padded: true,
        deleteCallback: Craft.WebAuthnFormHandler.removeExcludedCredential,
        beforeDelete: id => new Promise((resolve) => Craft.elevatedSessionManager.requireElevatedSession(() => resolve(true), () => resolve(false)))
    });
{% endjs %}
