{% set username = craft.app.config.general.rememberUsernameDuration ? craft.app.user.getRememberedUsername(): '' %}
{% set user = user|default(username ? craft.users.username(username).one() : null) %}

{% if username and (user is null) %}
    {% set user = craft.app.elements.createElement({type: "craft\\elements\\User", "username": username}) %}
{% endif %}

{% set authenticationChain = user is not null? craft.app.authentication.getCpAuthenticationChain(user) : null %}
{% set alternativeSteps = authenticationChain.alternativeSteps|default(null) %}
{% set showRememberMe = craft.app.config.general.rememberedUserSessionDuration %}

{% embed '_special/login/authentication_chain' %}
    {% import "_includes/forms" as forms %}

    {% block switchUser %}
        {% if username|length > 0 or (authenticationChain is not null and not authenticationChain.isComplete) %}
            {% set knownUserName = user.username|default(username) %}
                <div id="authentication-greeting">{{ 'Hello, {user}'|t('app', {user: knownUserName}) }}. (<a id="restart-authentication">{{ 'Not {user}?'|t('app', {user: knownUserName}) }}</a>)</div>
                <hr />
        {% endif %}
    {% endblock %}

    {% block authStepHtml %}
        {% if authenticationChain is not null %}
            {% if not authenticationChain.isComplete %}
                {{ authenticationChain.nextAuthenticationStep.inputFieldHtml|raw }}
            {% else %}
                <div id="spinner-pending" class="spinner big over-bg"></div>
            {% endif %}
        {% endif %}
    {% endblock %}

    {% block startAuthentication %}
        {% if craft.app.config.general.useEmailAsUsername %}
            {% set usernameLabel = 'Email'|t('app') %}
            {% set usernameType = 'email' %}
        {% else %}
            {% set usernameLabel = 'Username or Email'|t('app') %}
            {% set usernameType = 'text' %}
        {% endif %}

        <div id="start-authentication" class="{{ (user is not null) ? 'hidden' : '' }}">
            {{ forms.textField({
                id: 'loginName',
                name: 'username',
                placeholder: usernameLabel,
                value: username,
                autocomplete: 'username',
                type: usernameType,
                inputAttributes: {
                    aria: {
                        label: usernameLabel,
                        required: 'true',
                    },
                },
            }) }}
        </div>
    {% endblock %}

    {% block alternativeSteps %}
        {% if alternativeSteps is not null %}
            <div id="alternative-types" class="{{ (alternativeSteps|length == 0) ? 'hidden' : '' }}" >
                <label>Other options:</label>
                <ul>
                    {% for type, name in authenticationChain.alternativeSteps %}
                    <li rel="{{ type }}">{{ name }}</li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %}
    {% endblock %}

    {% block rememberMe %}
        {% if showRememberMe %}
            {{ forms.checkboxField({ id: 'rememberMe', label: 'Keep me logged in'|t('app') }) }}
        {% endif %}

    {% endblock %}

    {% block accountRecovery %}
            <button id="recover-account" rel="recovery" type="button">{{ 'Trouble logging in?'|t('app') }}</button>
            <button id="cancel-recover" rel="authentication"   class="hidden" type="button">{{ 'Back to login'|t('app') }}</button>
    {% endblock %}
{% endembed %}
