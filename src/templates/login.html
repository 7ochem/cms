{% extends "_layouts/basecp" %}
{% import "_includes/forms" as forms %}
{% set title = "Login"|t('app') %}
{% set bodyClass = 'login' %}

{% do view.registerAssetBundle("craft\\web\\assets\\login\\LoginAsset") %}

{% set username = craft.app.config.general.rememberUsernameDuration ? craft.app.user.getRememberedUsername(): '' %}
{% set showRememberMe = craft.app.config.general.rememberedUserSessionDuration %}
{% set hasLogo = CraftEdition == CraftPro and craft.rebrand.isLogoUploaded %}

{% set formAttributes = {
    id: 'login-form',
    method: 'post',
    class: showRememberMe ? 'remember-me' : '',
    'accept-charset': 'UTF-8',
} %}

{% if hasLogo %}
    {% set logo = craft.rebrand.logo %}
{% endif %}

{% set formHtml %}
    <main>
        <div id="login">
            <h1>
                {% if hasLogo %}
                    {{ tag('img', {
                        id: 'login-logo',
                        src: logo.url,
                        alt: systemName,
                        width: logo.width,
                        height: logo.height,
                    }) }}
                {% else %}
                    {{ systemName }}
                {% endif %}
            </h1>

            <form {{ attr(formAttributes) }}>
                {% set authenticationChain = craft.app.authentication.cpAuthenticationChain %}
                <div class="authentication-chain" id="authentication" rel="{{ authenticationChain.nextAuthenticationStep ? authenticationChain.nextAuthenticationStep.stepType : '' }}" data-endpoint="authentication/perform-authentication">
                    {% if not authenticationChain.isComplete %}
                        {{ authenticationChain.nextAuthenticationStep.fieldHtml|raw }}
                    {% else %}
                        <div id="spinner-pending" class="spinner big over-bg"></div>
                    {% endif %}
                </div>

                {% if authenticationChain.isNew %}
                    {% set recoveryChain = craft.app.authentication.getCpRecoveryChain(true) %}
                    <div class="authentication-chain hidden" id="recovery" data-endpoint="authentication/recover-account">
                        {% if not recoveryChain.isComplete %}
                            {{ recoveryChain.nextAuthenticationStep.fieldHtml|raw }}
                        {% endif %}
                    </div>
                {% endif %}

                {% set alternativeSteps = authenticationChain.alternativeSteps %}

                <div id="alternatives" class="{{ (alternativeSteps|length == 0) ? 'hidden' : '' }}" >
                    <label>Other options:</label>
                    <ul>
                        {% for type, name in authenticationChain.alternativeSteps %}
                            <li rel="{{ type }}">{{ name }}</li>
                        {% endfor %}
                    </ul>
                </div>

                {% if authenticationChain.isNew %}
                    <div id="login-form-bottom">
                        {% if showRememberMe %}
                            {{ forms.checkboxField({ id: 'rememberMe', label: 'Keep me logged in'|t('app') }) }}
                        {% endif %}

                        <button id="recover-account" rel="recovery" type="button">{{ 'Trouble logging in?'|t('app') }}</button>
                        <button id="cancel-recover" rel="authentication"   class="hidden" type="button">{{ 'Back to login'|t('app') }}</button>
                    </div>
                {% endif %}

                <div class="buttons">
                    {% if not authenticationChain.isComplete %}
                        <button id="submit" class="btn submit" type="submit">{{ 'Submit'|t('app') }}</button>
                        <div id="spinner" class="spinner over-bg hidden"></div>
                    {% endif %}
                </div>
            </form>

            <div id="login-errors" role="alert">
            </div>

            <div id="login-messages" role="alert">
            </div>

            <a id="poweredby" href="http://craftcms.com/" title="{{ 'Powered by Craft CMS'|t('app') }}" aria-label="{{ 'Powered by Craft CMS'|t('app') }}">
                {{ svg('@app/web/assets/cp/dist/images/craftcms.svg') }}
            </a>

        </div>

    </main>
{% endset %}

{% set noCookiesHtml %}
    <main>
        <div class="message-container no-access">
            <div class="pane notice">
                <p>{{ 'Cookies must be enabled to access the Craft CMS control panel.'|t('app') }}</p>
            </div>
        </div>
    </main>
{% endset %}

{% block body %}
    <script type="text/javascript">
        var cookieTest = 'CraftCookieTest='+Math.floor(Math.random() * 1000000);
        document.cookie = cookieTest;
        if (document.cookie.search(cookieTest) != -1) {
            document.cookie = cookieTest + '=; expires=Thu, 01 Jan 1970 00:00:01 GMT;';
            document.write({{ formHtml|json_encode|raw }});
        } else {
            document.write({{ noCookiesHtml|json_encode|raw }});
        }
    </script>
{% endblock %}
